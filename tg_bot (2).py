from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
from ultralytics import YOLO
import os
from datetime import datetime

# Загрузка модели YOLOv8
model = YOLO('/Users/uladzislauyermakou/Desktop/FINAL/YOLO-final/best.pt')

# Словарь перевода классов
class_translations = {
    'Adenium': 'Адениум',
    'Adiantum': 'Адиантум',
    'Aglaonema': 'Аглаонема',
    'Alocasia': 'Алоказия',
    'Aloe Vera': 'Алоэ Вера',
    'Amaryllis': 'Амариллис',
    'Anthurium': 'Антуриум',
    'Araucaria Heterophylla': 'Араукария разнолистная',
    'Bambusa': 'Бамбук',
    'Beaucarnea Recurvata': 'Бокарнея отогнутая',
    'Begonia': 'Бегония королевская',
    'Begonia Rex': 'Бегония Рекс',
    'Chlorophytum comosum': 'Хлорофитум хохлатый',
    'Crassula ovata': 'Толстянка яйцевидная',
    'Croton': 'Кротон',
    'Curio rowleyanus': 'Крестовник роули',
    'Dieffenbachia': 'Диффенбахия',
    'Dracaena trifasciata': 'Драцена трёхполосная',
    'Echeveria': 'Эхеверия',
    'Epipremnum aureum': 'Эпипремнум золотистый',
    'Euphorbia milii': 'Молочай Миля',
    'Euphorbia pulcherrima': 'Молочай красивейший',
    'Fatsia japonica': 'Фатсия японская',
    'Ficus benjamina': 'Фикус Бенджамина',
    'Ficus elastica': 'Фикус каучуконосный',
    'Ficus lyrata': 'Фикус лировидный',
    'Haworthia attenuata': 'Хавортия оттянутая',
    'Hedera helix': 'Плющ обыкновенный',
    'Hypoestes phyllostachya': 'Гипоэстес листоколосниковый',
    'Kalanchoe': 'Каланхоэ',
    'Mesembryanthemum cordifolium': 'Мезембриантемум сердцелистный',
    'Monstera deliciosa': 'Монстера деликатесная',
    'Nephrolepis Boston': 'Нефролепис возвышенный',
    'Opuntia microdasys': 'Опунция мелковолосистая',
    'Pachira aquatica': 'Пахира водная',
    'Pachypodium lamerei': 'Пахиподиум Ламера',
    'Pedilanthus': 'Педилантус',
    'Pelargonium': 'Пеларгония',
    'Pelargonium - hortorum': 'Пеларгония садовая',
    'Peperomia caperata': 'Пеперомия сморщенная',
    'Phalaenopsis': 'Фаленопсис',
    'Pilea peperomioides': 'Пилея пеперомиоидная',
    'Royal Pelargonium': 'Пеларгония плющелистная',
    'Schefflera actinophylla': 'Шеффлера лучелистная',
    'Spathiphyllum': 'Спатифиллум',
    'Syngonium': 'Сингониум',
    'Thaumatophyllum bipinnatifidum': 'Филодендрон двоякоперистый',
    'Tradescantia fluminensis': 'Традесканция приречная',
    'Verbena': 'Вербена',
    'Zamioculcas': 'Замиокулькас'
}

# Пример словаря с описаниями классов на русском языке
class_descriptions = {
    'Адениум': 'Адениум, также известный как пустынная роза или адениум арабский, — это декоративное растение, ценимое за свои эффектные цветки и необычную форму ствола. Адениумы часто используются в качестве домашних декоративных растений или в садовом дизайне. Основные рекомендации по уходу за этим растениемы: https://dzengarden.ru/komnatnoe-rastenie/adenium/',
    'Адиантум': 'Адиантум, также известный как птерис или папоротник венерин волос, — это элегантное декоративное растение с тонкими, деликатными листьями. Адиантумы особенно ценятся за свою изысканность и способность добавить зелени и свежести в интерьер. Основные рекомендации по уходу за этим растением: https://luxuryplants.ru/ukhod/adiantum-ukhod/',
    'Аглаонема': 'Аглаонема — это декоративное комнатное растение, ценящееся за свои эффектные листья с разнообразными узорами и цветами. Оно легко адаптируется к условиям домашнего содержания и довольно неприхотливо в уходе. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/aglaonema/',
    'Алоказия': 'Алоказия — это декоративное растение, известное своими крупными, эффектными листьями и экзотическим видом. В уходе алоказия требует внимания и соблюдения определённых условий, чтобы сохранить здоровье и красоту. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/alokaziya/',
    'Алоэ Вера': 'Алоэ вера — это популярное суккулентное растение, известное своими лечебными свойствами и декоративным видом. Оно легко выращивается в домашних условиях и требует минимального ухода. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/aloeh/',
    'Амариллис': 'Амариллис — это декоративное растение, известное своими крупными, эффектными цветами. В домашних условиях амариллис может стать настоящим украшением благодаря своим ярким цветкам и неприхотливости в уходе. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/amarillis/',
    'Антуриум': 'Антуриум — это декоративное растение, известное своими яркими, блестящими цветами и красивой листвой. Антуриум часто используется в интерьере для создания экзотической атмосферы. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/anturium/',
    'Араукария разнолистная': 'Араукария разнолистная, также известная как Араукария Норфолка или Норфолкская сосна, — это декоративное дерево, которое часто выращивают в помещении как комнатное растение. Основные рекомендации по уходу за этим растением: https://rastenievod.com/araukariya.html',
    'Бамбук': 'Бамбук — это быстрорастущее и декоративное растение, которое можно выращивать как в помещении, так и на улице. В домашних условиях бамбук часто используется для создания зелёных изгородей, живых стен или просто как декоративное растение. Основные рекомендации по уходу за этим растением: https://flowwow.com/blog/komnatniy-bambuk-ukhod-v-domashnikh-usloviyakh/',
    'Бокарнея отогнутая': 'Бокарнея отогнутая, также известная как Ножка слона или Бокарнея, — это декоративное комнатное растение, которое отличается своей необычной формой и стойкостью. Основные рекомендации по уходу за этим растением: https://growbox.ru/media/tpost/bst7v79861-nolina-bokarneya',
    'Бегония королевская': 'Бегония королевская — это одна из самых декоративных видов бегоний, известная своими эффектными листьями с разнообразными цветами и узорами. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/begoniya/',
    'Бегония Рекс':'Бегония Рекс - отличается разнообразием окраски листьев. Это травянистое кустовидное растение с мясистым стеблем. Листья крупные, с округлой верхушкой и неравномерно-зубчатыми, слабоволнистыми краями. Многообразие окраски листьев поражает - различное сочетание цветов, узоров, мраморности рисунка.Основные рекомендации по уходу за этим растением: https://la-kosta.ru/ornamental-foliage-plants/begonias/begoniya-reks-(listovaya)',
    'Хлорофитум хохлатый':'Хлорофитум - это многолетнее травянистое растение с узкими свисающими листьями и усиками, дающими начало новым кустикам. Это очень неприхотливое растение, которое может расти практически в любом грунте и при любой освещенности. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/hlorofitum/',
    'Толстянка яйцевидная':'Толстянка яйцевидная, также известная как "денежное дерево", — популярное комнатное растение из семейства толстянковых. Оно привлекает внимание своими мясистыми листьями, которые напоминают монеты. Основные рекомендации по уходу за этим растением: https://artplants.ru/news/uhod-za-rasteniyami/krassula-denezhnoe-derevo-pravilnyy-ukhod ',
    'Кротон': 'Кротон, также известный как кодиеум, — это декоративное комнатное растение, известное своими яркими и разнообразными листьями. Его яркие листья могут быть зелеными, красными, желтыми, оранжевыми и пурпурными, часто с причудливыми пятнами и полосами. Основные рекомендации по уходу за этим растением: https://topplant.ru/blog/care-flowers/uxod-za-krotonom ',
    'Крестовник роули': 'Крестовник Роули, также известный как "нитка жемчуга" или "ожерелье из жемчуга", — это суккулентное растение, привлекающее внимание своими необычными округлыми листьями, напоминающими жемчужины. Оно популярно как комнатное растение благодаря своей декоративности и относительно простому уходу. Основные рекомендации по уходу за этим растением: https://my-plants.com/articles/58/.',
    'Диффенбахия': 'Диффенбахия - тропическое вечнозеленое растение культивируется уже 150 лет, оно полюбилось цветоводам за исключительные декоративные свойства. Основные рекомендации по уходу за этим растением: https://geoglass.ru/vse-o-rasteniyakh/diffenbahiya-uhod/',
    'Драцена трёхполосная': 'Драцена трёхполосная, также известная как Драцена фрагранс или Драцена деремская, — это популярное комнатное растение, известное своими длинными, узкими листьями с характерными полосами. Это растение не только украшает интерьер, но и очищает воздух. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/dracena/',
    'Эхеверия': 'Эхеверия — это род суккулентных растений, который насчитывает множество видов и разновидностей. Они известны своими розетками из мясистых листьев, которые могут иметь различную форму и цвет, от зеленого до голубого, розового и фиолетового. Эти растения популярны за свою неприхотливость и декоративный вид. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/ehkheveriya/',
    'Эпипремнум золотистый': 'Эпипремнум золотистый, также известный как потос, дьявольский плющ или золотой потос, — это популярное комнатное растение, ценимое за свои яркие, сердцевидные листья с золотистыми или белыми пятнами. Это растение очень неприхотливо и быстро растет, что делает его идеальным выбором для озеленения помещений. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/ehpipremnum/',
    'Молочай Миля': 'Молочай Миля — это декоративное растение, также известное как корона терновника или молочай коронка. Оно относится к семейству Молочайных и известно своими яркими цветами и колючими стеблями. Это растение широко используется в декоративных целях и достаточно неприхотливо в уходе. Основные рекомендации по уходу за этим растением: https://growbox.ru/media/tpost/6uc19psd91-molochai-milya',
    'Молочай красивейший': 'Молочай красивейший, часто называемый пуансеттия или пойсентия, — это декоративное растение, особенно популярное в зимний период благодаря своим ярким и эффектным прицветникам. Основные рекомендации по уходу за этим растением: https://growbox.ru/media/tpost/6uc19psd91-molochai-milya',
    'Фатсия японская': 'Кустарник, вырастающий в домашних условиях до 2 метров в высоту. Листья располагаются на длинных черешках, вырастают до 30 сантиметров в длину и ширину. Листья имеют от 5 до 9 лопастей, глянцевую поверхность и ярко-зеленый цвет. Фатсия — несложное растение. С уходом за ней справится даже начинающий цветовод. Следует учитывать, фатсия быстро растет и занимает довольно много места. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/fatsiya/',
    'Фикус Бенджамина': 'Один из самых  распространенных видов. Имеет как высокорослые, так и карликовые сорта с разной формой листовых пластин: яйцевидная, мечевидная, в форме кленового листа, кучерявые и с округлыми краями. Цилиндрический стебель обладает зелено-коричневым цветом. Плоды небольшого размера, схожи с немного удлиненными орехами. Бенджамины — довольно капризные растения. Основные рекомендации по уходу за этим растением: https://green-land.ru/information/articles/1479/322242/',
    'Фикус каучуконосный': 'Крупный вид. В домашних условиях может вырасти до 2 метров в высоту. Листья вытянутые, 20 сантиметров в длину, 10 – в ширину, с заостренными кончиками. От других представителей отличается расцветкой листьев: листовая пластина зеленая, с кремовой каймой и светло-зелеными пятнами по всему листу. Основные рекомендации по уходу за этим растением: https://www.picturethisai.com/ru/care/Ficus_elastica.html',
    'Фикус лировидный': 'Вид получил свое название благодаря большим листьям лировидной формы. Даже в помещении может вырасти более трех метров. Капризный вид, не любит сухой воздух, сквозняки. Основные рекомендации по уходу за этим растением: https://geoglass.ru/vse-o-rasteniyakh/lirata-uhod/',
    'Хавортия оттянутая': 'Хавортия оттянутая — это компактное и декоративное суккулентное растение, известное своими мясистыми, зелёными листьями с характерными белыми шипами или полосками. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/havortiya/',
    'Плющ обыкновенный': 'Плющ - неприхотливое растение, которое легко выращивать в домашних условиях. Он быстро растет, прекрасно очищает воздух и может украсить любую комнату. Основные рекомендации по уходу за этим растением: https://flowers.ua/ru/articles/plyushch-komnatnyy-hedera-uhod-i-vyrashchivanie-v-domashnih-usloviyah',
    'Гипоэстес листоколосниковый': 'Гипоэстес – небольшие (до 60 см в длину) вечнозеленые кустарники. Корневая система плохо развита, корни тонкие и нежные. Листья небольшие, до 10 см в длину, супротивные, яйцевидной формы, на конце заостренные, цельнокрайные или зубчатокрайные. Основные рекомендации по уходу за этим растением: https://floriculture.me/rast/Hypoestes.shtml',
    'Каланхоэ': 'Каланхоэ — это род суккулентных растений, известный своими яркими цветами и мясистыми листьями. Эти растения хорошо подходят для выращивания в домашних условиях и могут украшать интерьер своими декоративными качествами. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/kalanhoeh/',
    'Мезембриантемум сердцелистный': 'Мезембриантемум сердцелистный, также известный как аптения сердцелистная или аптения вариегатная, — это суккулентное растение, которое отличается сердцевидными листьями и яркими цветками. Оно часто используется в качестве почвопокровного растения или ампельного растения в подвесных корзинах. Основные рекомендации по уходу за этим растением: https://www.picturethisai.com/ru/care/Mesembryanthemum_cordifolium.html',
    'Монстера деликатесная': 'Монстера деликатесная, также известная как монстера привлекательная или монстера дырчатая, — это популярное комнатное растение, ценимое за свои крупные, рассеченные листья с характерными отверстиями. Оно привлекает внимание своим экзотическим видом и является прекрасным дополнением к интерьеру. Монстера относительно неприхотлива в уходе. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/monstera/',
    'Нефролепис возвышенный': 'Нефролепис возвышенный, также известный как папоротник нефролепис или папоротник «Сабля», — это декоративное комнатное растение, ценимое за свои изящные, перистые листья. Этот папоротник добавляет зелени и свежести в интерьер и может быть выращен как подвесное растение или в кашпо. Основные рекомендации по уходу за этим растением: https://geoglass.ru/vse-o-rasteniyakh/nefrolepis/',
    'Опунция мелковолосистая': 'Опунция мелковолосистая, также известная как опунция «Падука» или опунция «Белый кактус», — это вид кактуса, характерный своими мелкими, волосистыми шипами. Она привлекает внимание своей необычной внешностью и является популярным выбором для коллекционеров кактусов и любителей суккулентов. Основные рекомендации по уходу за этим растением: https://botaniccraft.ru/product/kaktus-opuntsiya-melkovolosistaya-2/',
    'Пахира водная': 'Пахира водная, также известная как пахира денежное дерево или бокопа, — это декоративное растение с крупными, блестящими листьями и необычными плодами. Пахира часто используется в качестве комнатного растения из-за своей неприхотливости и способности адаптироваться к различным условиям. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/pahira/.',
    'Пахиподиум Ламера': 'Пахиподиум Ламера, также известный как пахиподиум Ламера или вилочковое дерево, — это эффектное суккулентное растение, которое часто выращивается как декоративное комнатное растение. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/pahipodium/',
    'Педилантус': 'Педилантус — это род растений из семейства Молочайных, который включает несколько декоративных видов, таких как Педилантус тетрапус, также известный как змеиное дерево или ножевой молочай. Педилантус привлекает внимание своими необычными листьями и необычной формой, а также красочными цветами. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/pedilantus/',
    'Пеларгония': 'В Европе пеларгония считалась аристократическим растением, потому что её можно было встретить почти в каждой оранжерее, принадлежащей состоятельному владельцу. В России цветок после революции прозвали «мещанским». Длительное время его не выращивали, пока не появились клубы любителей пеларгонии.Основные рекомендации по уходу за этим растением: https://indoor-plants.org/katalog-rastenij/derevja-i-kustarniki/pelargonium/',
    'Пеларгония садовая': 'Пеларгония садовая, также известная как пеларгония зональная или пеларгония кордовая, является популярным декоративным растением, которое часто используется для украшения садов и балконов. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/pelargoniya/',
    'Пеперомия сморщенная': 'Пеперомия сморщенная — это декоративное комнатное растение, отличающееся своими необычными, сморщенными и волнистыми листьями. Оно принадлежит к семейству Пиперовых и популярно благодаря своей компактной форме и разнообразной окраске листвы. Основные рекомендации по уходу за этим растением: https://www.ooorost.ru/167-peperomiya-smorshchennaya.html',
    'Фаленопсис': 'Фаленопсис, также известный как орхидея-бабочка, является одним из самых популярных видов орхидей благодаря своим эффектным цветкам и сравнительной неприхотливости в уходе. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/falenopsis/',
    'Пилея пеперомиоидная': 'Пилея пеперомиоидная, также известная как пилея или пилея Сингониума, — это популярное комнатное растение, известное своими декоративными круглыми листьями и легкостью в уходе. Основные рекомендации по уходу за этим растением: https://www.picturethisai.com/ru/care/Pilea_peperomioides.html',
    'Пеларгония плющелистная': 'Пеларгония плющелистная, также известная как пеларгония ампельная или пеларгония плющелистная, — это декоративное растение, которое часто используется для создания подвесных композиций и балконных контейнеров. Основные рекомендации по уходу за этим растением: https://7semyan.ru/blog/pelargoniya-plyushchelistnaya-ampelnaya-krasavitsa-dlya-doma-i-sada/',
    'Шеффлера лучелистная': 'Шеффлера лучелистная - это известное и адаптивное растение, способное переносить различные условия в помещении, что делает его относительно легким в уходе. Оно требует постоянной влажности, но подвержено корневой гнили, поэтому важно обеспечить правильный дренаж и избегать чрезмерного полива. Основные рекомендации по уходу за этим растением:https://www.picturethisai.com/ru/care/Schefflera_actinophylla.html',
    'Спатифиллум': 'Спатифиллум, также известный как женское счастье, — это популярное декоративное растение с элегантными белыми или кремовыми цветами и блестящими зелеными листьями. Оно известно своей способностью очищать воздух и легко адаптируется к условиям домашнего содержания. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/spatifillum/',
    'Сингониум': 'Сингониум – привлекательное растение ампельного типа, которое относится к семейству Ароидных. Считается многолетним и является родом из Америки. Достаточно часто используется садоводами для оформления комнатного интерьера за счет несложного ухода. Основные рекомендации по уходу за этим растением: https://green-7.ru/news/singonium-ukhod-za-rasteniem-v-domashnikh-usloviyakh/',
    'Филодендрон двоякоперистый': 'Это редкое и необычное растение, которое привлекает внимание своей уникальной формой и фактурой листьев. Уход за ним требует некоторых специфических знаний. Основные рекомендации по уходу за этим растением: https://www.picturethisai.com/ru/care/Philodendron_bipinnatifidum.html',
    'Традесканция приречная':'Также известная как “Традесканция зебровидная” или “Вариегатная традесканция”, - это популярное ампельное растение с красивыми пестрыми листьями. Основные рекомендации по уходу за этим растением: https://www.belta.by/socium/view/tradeskantsija-domashnjaja-uhod-vidy-bolezni-peresadka-611296-2024',
    'Вербена': 'Это растение в представлении многих является прежде всего ценным лекарственным растением. В природе существует более 100 видов вербены, и многие из них внешне кардинально отличаются друг от друга, но обладают общими свойствами – устойчивостью к жаре, засухе и крайней неприхотливостью. Основные рекомендации по уходу за этим растением: https://www.kp.ru/family/sad-i-ogorod/verbena/',
    'Замиокулькас': 'Замиокулькас, также известный как долларовое дерево или замиокулькас, — это популярное комнатное растение, которое ценится за свою неприхотливость и декоративные, плотные листья. Основные рекомендации по уходу за этим растением: https://dzengarden.ru/komnatnoe-rastenie/zamiokulkas/'
    }

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('Привет! Отправьте фотографию растения для определения 🪴.')

# Установите порог уверенности
CONFIDENCE_THRESHOLD = 0.4  # Например, 0.5 или 50%

async def detect(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        photo = update.message.photo[-1]
        photo_file = await photo.get_file()
        output_dir = os.getenv('IMAGE_OUTPUT_DIR', '/Users/uladzislauyermakou/Desktop/FINAL/YOLO-final/images')
        os.makedirs(output_dir, exist_ok=True)

        # Создаем уникальное имя для файла
        photo_path = os.path.join(output_dir, f"detect_image_{update.message.message_id}.jpg")
        await photo_file.download_to_drive(photo_path)

        # Выполнение детекции
        results = model(photo_path)

        # Проверка структуры результатов
        if not results or len(results) == 0 or not hasattr(results[0], 'boxes'):
            await update.message.reply_text('Не удалось обнаружить объекты.')
            return

        # Извлечение детекций
        detections = results[0].boxes
        response = []

        for detection in detections:
            confidence = detection.conf[0]  # Получаем уверенность детекции
            if confidence < CONFIDENCE_THRESHOLD:
                continue  # Пропускаем объекты с низкой уверенностью

            class_id = int(detection.cls[0])
            class_name = model.names[class_id]  # Используем model.names для получения имени класса

            # Переводим имя класса на русский
            translated_class_name = class_translations.get(class_name, class_name)
            # Получаем описание на русском
            description = class_descriptions.get(translated_class_name, "Описание отсутствует.")

            response.append(f"Наименование: {translated_class_name}\nОписание: {description}\nУверенность: {confidence:.2f}")

        if response:
            await update.message.reply_text('\n\n'.join(response))
        else:
            await update.message.reply_text('Объекты с высокой уверенностью не обнаружены.')

    except Exception as e:
        await update.message.reply_text(f'Произошла ошибка: {str(e)}')

def main() -> None:
    app = ApplicationBuilder().token("7372220207:AAFHaiJLYlawhVM_hqRoS1fSpdNVBFBUIg4").build()
  # Замените на ваш токен

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.PHOTO, detect))

    app.run_polling()

if __name__ == '__main__':
    main()

   